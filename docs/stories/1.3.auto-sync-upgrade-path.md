# Story 1.3: Auto-Sync Upgrade Path

## Status
Draft - By Bob (Scrum Master) @ 2025-10-06 17:45 UTC

## Story
**As a** premium KeepSidian user who opted into beta two-way sync,
**I want** auto sync to upgrade to the full two-way flow whenever safeguards pass,
**so that** scheduled sync keeps my vault and Google Keep aligned without dropping the beta safety rails.

## Acceptance Criteria
1. When auto sync triggers and backup acknowledgement, manual two-way, auto two-way, and premium requirements are all satisfied, the plugin runs the complete two-way workflow (import then push) instead of the import-only path. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
2. If any safeguard prerequisite or premium requirement is missing, the auto sync run must stay import-only so download fallback remains unaffected. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
3. Whenever two-way upgrade is skipped, the run records a clear warning that points back to beta settings so the user understands why uploads were omitted. [Source: docs/epics/two-way-sync-beta-safeguards.md#Enhancement Scope; docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
4. Auto sync reevaluates safeguards each interval, honoring toggle and subscription changes without a reload while preserving the default download-only behaviour when the beta is off. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook; docs/epics/two-way-sync-beta-safeguards.md#Definition of Done]

## Tasks / Subtasks
- [ ] Route auto sync through the shared safeguard evaluation before choosing a sync mode (AC: 1, 2). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories; docs/stories/1.2.command-ui-safety-gates.md]
  - [ ] Call `requireTwoWaySafeguards({ requireAutoSync: true })` inside the interval callback and switch between `performTwoWaySync()` and `importNotes(true)` accordingly (AC: 1, 2). [Source: docs/stories/1.2.command-ui-safety-gates.md; docs/architecture.md#Layers]
  - [ ] Force-refresh subscription status before evaluating safeguards by calling `this.subscriptionService.isSubscriptionActive(true)` so newly activated premium users upgrade immediately (AC: 1, 4). [Source: src/services/subscription.ts; docs/stories/1.2.command-ui-safety-gates.md]
  - [ ] Preserve the `isSyncing` guard and interval registration so only one sync runs at a time (AC: 2). [Source: docs/architecture.md#Data Flow]
- [ ] Surface safe warnings when safeguards block uploads while keeping downloads intact (AC: 2, 3). [Source: docs/epics/two-way-sync-beta-safeguards.md#Enhancement Scope; docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
  - [ ] Log gating reasons in the sync log and reuse the beta settings deep link so users can resolve blockers (AC: 3). [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook; docs/stories/1.2.command-ui-safety-gates.md]
  - [ ] Persist the most recent auto-sync gating message on the plugin (for example `lastAutoSyncGateReasons`) and only emit a new Notice when the reasons change; reset the cache after a successful two-way run (AC: 3). [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook; src/app/main.ts]
  - [ ] Prevent repeated auto sync runs from spamming duplicate notices within the same session while still guiding the user (AC: 3). [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- [ ] Recompute safeguards whenever settings or subscription cache changes so future intervals reflect the latest state (AC: 4). [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook; docs/stories/1.1.settings-section-defaults.md]
  - [ ] Ensure settings tab callbacks or subscription refreshes trigger `startAutoSync()` only after gating state normalizes (AC: 4). [Source: docs/stories/1.1.settings-section-defaults.md; docs/stories/1.2.command-ui-safety-gates.md]
- [ ] Extend Jest coverage for auto sync upgrade and fallback paths (AC: 1-4). [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
  - [ ] Update `src/app/tests/main.test.ts` auto sync suite to assert two-way runs when safeguards pass and import-only otherwise (AC: 1, 2). [Source: docs/epics/two-way-sync-beta-safeguards.md#Manual Regression Checklist]
  - [ ] Cover logged warnings or notice triggers so releases capture evidence for blocked auto uploads (AC: 3, 4). [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]

## Dev Notes

### Previous Story Insights
- Story 1.1 introduced and persists the three beta toggles; reuse those booleans rather than reimplementing default state. [Source: docs/stories/1.1.settings-section-defaults.md]
- Story 1.2 centralized safeguard evaluation via `requireTwoWaySafeguards`, `showTwoWaySafeguardNotice`, and the deep link helper; auto sync should reuse that flow instead of duplicating checks. [Source: docs/stories/1.2.command-ui-safety-gates.md]

### Data Models
- `KeepSidianPluginSettings` already stores `twoWaySyncBackupAcknowledged`, `twoWaySyncEnabled`, and `twoWaySyncAutoSyncEnabled` booleans that gate uploads; no new persisted state is expected. [Source: docs/stories/1.1.settings-section-defaults.md]
- Subscription status lives in `settings.subscriptionCache` and is normalized via `SubscriptionService`, so auto sync should rely on that cache before firing fresh checks and call `isSubscriptionActive(true)` when the interval runs to refresh recent upgrades. [Source: src/services/subscription.ts; docs/epics/two-way-sync-beta-safeguards.md#Enhancement Scope]

### API Specifications
- Auto sync continues to call `importGoogleKeepNotes` for the download stage and `pushGoogleKeepNotes` for uploads when conditions allow. [Source: docs/architecture.md#Data Flow; docs/tmp/prds/push_features_prd.md]
- Two-way sync still communicates with the Flask server via existing endpoints; no new HTTP contracts are introduced. [Source: docs/epics/two-way-sync-beta-safeguards.md#Epic Description]

### Component Specifications
- Auto sync orchestration lives inside `KeepSidianPlugin.startAutoSync()` and the interval callback in `src/app/main.ts`; adjustments should stay within the App layer. [Source: docs/architecture.md#Layers]
- Safeguard helpers already exist on the plugin instance, so reuse them instead of pulling settings directly from the UI layer. [Source: docs/stories/1.2.command-ui-safety-gates.md]

### File Locations
- Primary changes: `src/app/main.ts` for scheduler logic, plus `src/app/tests/main.test.ts` for coverage. [Source: docs/architecture.md#Layers]
- Settings and defaults remain in `src/types/keepsidian-plugin-settings.ts` and `src/ui/settings/KeepSidianSettingsTab.ts`; confirm no extra fields are needed. [Source: docs/stories/1.1.settings-section-defaults.md]

### Testing Requirements
- Unit tests should exercise auto sync intervals under both satisfied and unsatisfied safeguard permutations within `src/app/tests/main.test.ts`, including a forced subscription refresh path and the import-only fallback. [Source: src/app/tests/main.test.ts; docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
- Add coverage (unit or integration) proving duplicate gating notices are deduped while still logging the first warning each session. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- Manual regression checklist still runs auto sync timer with and without beta toggles; retain predictable log output to support that evidence. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- Future Playwright harness will rely on explicit gating hooks, so avoid hiding state changes behind internal closures. [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

### Technical Constraints
- Maintain download-only fallback so users without safeguards never push data inadvertently. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
- Avoid introducing new dependencies or long-running work inside the interval callback; auto sync should remain lightweight between checks. [Source: docs/architecture.md#Architecture Overview]
- Respect existing `isSyncing` guard to prevent overlapping import/push runs triggered by timers or manual commands. [Source: docs/architecture.md#Data Flow]
- Provide a single-session cache for auto-sync gating notices so repeated intervals do not overwhelm users; clear it once safeguards pass. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]

### Project Structure Notes
- Architecture shards referenced in configuration are still absent; continue relying on `docs/architecture.md` until supplemental files return. [Source: docs/stories/1.2.command-ui-safety-gates.md]

### Testing
- Use Jest via `npm run test` for new and updated unit tests covering auto sync gating paths. [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
- Keep future e2e readiness in mind by exposing observable hooks that Playwright can assert once the harness ships. [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-06 | 0.1 | Initial draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
-

### Debug Log References
-

### Completion Notes List
-

### File List
-

## QA Results
- Not yet reviewed.

## Validation Result

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY â€” Story provides sufficient context for implementation.

## PO Validation Report

- *Template Compliance Issues:* None observed; required sections remain complete.
- *Critical Issues:* RESOLVED. Story now directs developers to refresh subscription state via `subscriptionService.isSubscriptionActive(true)` before evaluating safeguards so new premium activations unlock two-way auto sync immediately (see Tasks and Dev Notes updates).
- *Should-Fix Issues:* RESOLVED. Guidance now specifies caching the last gating notice on the plugin to dedupe repeat warnings, and the Validation Result aligns with the updated status.
- *Nice-to-Have Improvements:* None.
- *Anti-Hallucination Findings:* No unsupported claims detected.
- *Final Assessment:* READY â€” Implementation readiness 9/10; Confidence High.
- *Next suggested step:* hand off to Development for implementation.
