# Story 1.1: Settings Section & Defaults

## Status
**Note:** Using status chain in this section. Append status and timestamp as story progresses.
Draft - By SM - 2025-10-05 14:00 ET
Approved - By PO - 2025-10-05 14:45 ET
Ready for Review - By Dev - 2025-10-05 19:24 UTC
Ready for Review - By Dev - 2025-10-06 21:40 UTC
Ready for Review - By Dev - 2025-10-06 22:15 UTC
Done - By QA - 2025-10-06 22:25 UTC

## Story
**As a** cautious KeepSidian user evaluating beta uploads,
**I want** a guarded two-way sync settings section that requires explicit opt-in,
**so that** upload flows stay disabled until I confirm backups and enable the beta.

## Acceptance Criteria
1. A new "Enable two-way sync (beta)" subsection appears under Auto Sync with three toggles: backup acknowledgement, enable two-way sync, and enable two-way sync for auto-sync; all default to off. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
2. Toggle enablement is conditional: backup acknowledgement must be on before other toggles activate; the auto-sync toggle also requires premium status and the existing auto-sync flag. Disabled toggles render informative descriptions. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
3. Non-premium users see a lock icon and helper text on the auto-sync toggle, consistent with existing premium gating patterns. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
4. New toggle values persist within the plugin settings model with defaults that keep download-only behavior intact for users who do not opt in. [Source: docs/epics/two-way-sync-beta-safeguards.md#Epic Description]
5. Reopening the settings tab reflects saved toggle states and obeys the gating matrix without enabling uploads by default. [Source: docs/epics/two-way-sync-beta-safeguards.md#Enhancement Details]

## Tasks / Subtasks
- [x] Extend the settings schema and defaults with the three beta toggles, ensuring persistence aligns with existing settings patterns (AC: 1, 4). [Source: docs/architecture.md#Layers]
  - [x] Update `KeepSidianPluginSettings` types and default values to include new booleans. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
  - [x] Wire defaults through plugin load/save flows so download-only mode remains unchanged. [Source: docs/epics/two-way-sync-beta-safeguards.md#Enhancement Details]
- [x] Implement the "Enable two-way sync (beta)" subsection in `KeepSidianSettingsTab` with the three toggles and contextual copy (AC: 1, 3). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - [x] Render premium lock icon and tooltip on the auto-sync toggle when subscription requirements are not met. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
  - [x] Add supporting description text that links users back to backups guidance without triggering uploads. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
- [x] Apply gating logic so toggle interdependencies enforce backup acknowledgement, premium status, and auto-sync prerequisites (AC: 2, 3, 5). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - [x] Disable two-way toggles until backup acknowledgement is true, with inline notices explaining requirements. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
  - [x] Ensure stored values rehydrate correctly when settings reload, preventing auto-enabling uploads. [Source: docs/epics/two-way-sync-beta-safeguards.md#Definition of Done]
- [x] Add unit tests covering default values and toggle enablement matrix under the existing Jest setup (AC: 1, 2, 5). [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
  - [x] Verify persistence writes expected booleans and respects download-only behavior by default. [Source: docs/epics/two-way-sync-beta-safeguards.md#Definition of Done]

## Dev Notes

### Previous Story Insights
No previous stories exist in this epic; no carryover decisions to consider.

### Data Models
No specific guidance found in architecture docs.

### API Specifications
No external API changes are involved for this settings-only story. [Source: docs/architecture.md#Layers]

### Component Specifications
- Settings UI modifications live in `src/ui/settings/KeepSidianSettingsTab.ts`, following the existing Obsidian settings tab pattern. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- Premium gating leverages the subscription service already used elsewhere in the plugin; reuse existing lock icon patterns. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]

### File Locations
- Keep settings types and defaults in `src/types/keepsidian-plugin-settings.ts` and related barrels. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- Plugin load/save logic resides within `src/main.ts`, aligning with the layered architecture. [Source: docs/architecture.md#Layers]

### Testing Requirements
- Expand `src/ui/settings/tests/KeepSidianSettingsTab.test.ts` to assert default toggle states, gating permutations, and persistence round-trips through the settings model. [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
- Add complementary assertions in `src/ui/settings/tests/KeepSidianSettingsTab.ui.test.ts` to ensure disabled controls render lock icon/tooltips for non-premium users and the gating copy surfaces as expected. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- Plan to incorporate the forthcoming Playwright Electron harness (per Decision Log) to smoke-test the opt-in flow once the prototype lands. [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

### Technical Constraints
- Do not break download-only sync flows; beta toggles must leave uploads disabled unless all prerequisites are met. [Source: docs/epics/two-way-sync-beta-safeguards.md#Epic Description]
- Follow existing premium gating UX so non-premium users understand why auto-sync toggles remain locked. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]

### Project Structure Notes
- Architecture configuration references sharded docs that are absent; rely on `docs/architecture.md` until supplemental files are restored. [Source: docs/architecture.md#Architecture Overview]

### Testing
- `src/ui/settings/tests/KeepSidianSettingsTab.test.ts`
  - Defaults: all beta toggles false on fresh load/save cycle.
  - Gating matrix: backup acknowledgement required before other toggles enable; premium flag + auto-sync prerequisite for the auto-sync toggle.
  - Persistence: toggles rehydrate correctly after plugin reload.
- `src/ui/settings/tests/KeepSidianSettingsTab.ui.test.ts`
  - Lock icon and helper text for non-premium users remain visible.
  - Disabled toggles display explanatory messaging until prerequisites met.
- Future e2e: cover the enable/disable workflow via Playwright sandbox vault once the prototype suite is available (`tests/e2e` planned per Decision Log). [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-05 | 0.1 | Initial draft created | Bob (Scrum Master) |
| 2025-10-05 | 0.2 | Implemented beta settings defaults, gating UI, and tests | James (Developer) |
| 2025-10-06 | 0.3 | Replaced inline backup guidance with button, removed `createFragment` import, expanded UI tests | James (Developer) |
| 2025-10-06 | 0.4 | Refreshed auto sync gating for two-way toggles and added regression coverage | James (Developer) |

## Dev Agent Record

### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `npm run lint:ts`
- `npm test`

### Completion Notes
- Auto sync toggle now calls `updateTwoWaySettingsState`, ensuring auto two-way gating unlocks and relocks when prerequisites change.
- Added Jest UI regression verifying auto sync enable/disable updates descriptions, disabled state, and stored values for auto two-way.
- Re-ran lint (`npm run lint:ts`) and full test suite (`npm test`) to confirm the regression is closed.

### File List
- src/ui/settings/KeepSidianSettingsTab.ts
- src/ui/settings/tests/KeepSidianSettingsTab.ui.test.ts

## QA Results

### Review Date: 2025-10-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Safety defaults, persistence resets, and premium gating are implemented cleanly with good TypeScript coverage.
- **Blocking issue:** `updateTwoWaySettingsState` never runs when the primary `Enable auto sync` toggle changes, so the auto two-way toggle stays disabled/enabled based on stale state. Reproduce: start with defaults → flip "Confirm vault backups" on → enable "Enable two-way sync (beta)" → turn on "Enable auto sync" above. The auto two-way toggle remains disabled until another prerequisite toggle is touched, violating AC2/AC5. (src/ui/settings/KeepSidianSettingsTab.ts:432-540)

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ No formatting/lint blockers observed.
- Project Structure: ✓ Settings types/defaults wired through expected layers.
- Testing Strategy: ✗ UI tests never toggle auto sync after enabling manual two-way, so the regression escaped. Consider adding that permutation in src/ui/settings/tests/KeepSidianSettingsTab.ui.test.ts.
- All ACs Met: ✗ AC2 & AC5 fail due to stale gating state after changing auto sync.

### Improvements Checklist
- [ ] Recompute two-way gating state whenever `autoSyncEnabled` changes (call `updateTwoWaySettingsState` in that handler).
- [ ] Add a UI test that flips auto sync after manual two-way is enabled to confirm the auto toggle unlocks and relocks appropriately.
- [ ] Verify disabling auto sync while auto two-way is on immediately disables the control and updates copy.

### Security Review
- No new security surface; changes stay within local settings UI.

### Performance Considerations
- No performance concerns; toggle logic executes on user interaction only.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/1.1-settings-section-defaults.yml
Risk profile: Not produced during this review.
NFR assessment: Not produced during this review.

### Recommended Status
✗ Changes Required - See unchecked items above

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Auto sync handler now refreshes the beta toggles immediately, and the new UI test covers the enable/disable regression.
- Settings wiring remains clean; state guards prevent unsafe combinations when prerequisites change.

### Refactoring Performed
- None required during this QA pass.

### Compliance Check
- Coding Standards: ✓ Formatting/structure aligns with repo conventions.
- Project Structure: ✓ Changes stay within existing settings and typings layers.
- Testing Strategy: ✓ Added UI permutation test exercises auto sync toggling.
- All ACs Met: ✓ Gating now matches the matrix in AC2/AC5.

### Improvements Checklist
- [x] Recompute two-way gating after auto sync changes.
- [x] Cover auto sync toggle permutations in UI tests.
- [x] Confirm disabling auto sync re-locks the auto two-way control with updated copy.

### Security Review
- No additional risks introduced; interaction remains local UI state.

### Performance Considerations
- No concerns; recomputation only runs on user toggle events.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/1.1-settings-section-defaults.yml
Risk profile: Not produced during this review.
NFR assessment: Not produced during this review.

### Recommended Status
✓ Ready for Done

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Verified the beta toggles recompute state whenever auto sync, backup acknowledgement, or manual enablement changes, keeping uploads gated behind explicit opt-in.
- Regression coverage in `src/ui/settings/tests/KeepSidianSettingsTab.ui.test.ts` exercises the premium lock path, auto sync dependency, and reset behavior so AC1-5 stay protected.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ Formatting stays aligned with linted output.
- Project Structure: ✓ Settings types/defaults live in the existing layers.
- Testing Strategy: ✓ Jest suite covers gating permutations and defaults.
- All ACs Met: ✓ UI, persistence, and gating requirements hold.

### Improvements Checklist
- [ ] Consider re-evaluating subscription status on-demand if premium state changes while the settings tab remains open.

### Security Review
- No additional risks; changes remain local UI state handling.

### Performance Considerations
- Negligible impact—recomputations only run on user toggles.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/1.1-settings-section-defaults.yml
Risk profile: Not produced during this review.
NFR assessment: Not produced during this review.

### Recommended Status
✓ Ready for Done
