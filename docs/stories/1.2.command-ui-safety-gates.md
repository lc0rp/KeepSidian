# Story 1.2: Command & UI Safety Gates

## Status
**Note:** Using status chain in this section. Append status and timestamp as story progresses.
Draft - By SM - 2025-10-07 09:00 UTC
Approved - By PO - 2025-10-07 12:00 UTC
Ready for Review - By Dev - 2025-10-06 06:43 UTC
Ready for Review - By Dev - 2025-10-06 17:06 UTC
Done - By QA - 2025-10-06 17:37 UTC

## Story
**As a** cautious KeepSidian user evaluating push sync,
**I want** upload and two-way commands to stay gated across every UI entry point until I complete the beta safeguards,
**so that** I cannot trigger uploads without opting in and confirming my backups.

## Acceptance Criteria
1. The "Perform two-way sync" and "Upload to Google Keep" commands short-circuit behind the beta toggle prerequisites (backup acknowledgement, manual enablement, premium/auto-sync requirements) so uploads never run until the user opts in. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories; docs/epics/two-way-sync-beta-safeguards.md#Enhancement Details]
2. Status bar quick actions mirror the same gating, disabling two-way and upload items (or preventing execution) whenever safeguards are incomplete. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
3. Sync Progress modal buttons for two-way sync and upload stay disabled (or re-route) until safeguards pass, aligning modal behavior with command/menu gating. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
4. When gating blocks an action, the user sees an informative Notice or contextual message that deep-links to beta settings and preserves accessible copy/focus expectations. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories; docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
5. Download-only flows (manual import, status bar import, modal import) remain unaffected so the safe fallback works even when safeguards prevent uploads. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]

## Tasks / Subtasks
- [x] Centralize beta prerequisite evaluation within the plugin to return gating reasons before any upload/two-way path runs (AC: 1, 4, 5). [Source: docs/epics/two-way-sync-beta-safeguards.md#Enhancement Scope]
  - [x] Read the three beta toggles and premium status, resetting dependent toggles just as loadSettings currently does to enforce prerequisites. [Source: docs/stories/1.1.settings-section-defaults.md]
  - [x] Provide a helper that surfaces a Notice with deep link copy back to settings when safeguards fail. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
- [x] Wrap `Perform two-way sync` and `Upload to Google Keep` command callbacks with the gating helper so the commands short-circuit safely. (AC: 1, 4). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - [x] Ensure command notices reuse existing Notice patterns and avoid executing the underlying plugin methods when prerequisites fail. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- [x] Update status bar menu assembly in `src/app/sync-ui.ts` to disable or reroute two-way/upload entries when safeguards are incomplete. (AC: 2, 4, 5). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - [x] Add hover copy or inline messaging that explains why items are disabled and directs the user to settings. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- [x] Extend `SyncProgressModal` so its action buttons respect gating state and expose guidance when disabled. (AC: 3, 4). [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - [x] Inject gating metadata from `KeepSidianPlugin` (or an adapter) into the modal and update tests to cover disabled states. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- [x] Add Jest coverage for command, status bar, and modal gating behaviors, plus regression checks ensuring download-only paths still work. (AC: 1-5). [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
  - [x] Expand `src/app/tests/main.test.ts` (or new command-focused tests) to verify commands stop before running uploads and emit Notices/deep links. [Source: docs/epics/two-way-sync-beta-safeguards.md#Manual Regression Checklist]
  - [x] Update `src/app/sync-ui.ts` and `src/ui/modals/SyncProgressModal.ts` test suites to cover disabled buttons, copy, and accessibility expectations. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]

## Dev Notes

### Previous Story Insights
- Story 1.1 established the three beta toggles (backup acknowledgement, manual two-way enablement, auto-sync enablement) and persists them through settings load/save. Gating logic must consume those booleans without re-implementing defaults. [Source: docs/stories/1.1.settings-section-defaults.md]

### Data Models
- No new persisted structures; reuse the existing boolean toggles from the settings model introduced in Story 1.1. [Source: docs/stories/1.1.settings-section-defaults.md]

### API Specifications
- Server APIs stay unchanged for this story—gating occurs entirely within the Obsidian client. [Source: docs/epics/two-way-sync-beta-safeguards.md#Compatibility Requirements]

### Component Specifications
- Command guard patterns live in `src/app/commands.ts`; integrate gating before calling plugin sync methods. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- Status bar interactions and quick actions are orchestrated in `src/app/sync-ui.ts`; mirror settings gating and Notices there. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- `SyncProgressModal` handles modal buttons inside `src/ui/modals/SyncProgressModal.ts`; extend its state to reflect gating metadata and copy. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]
- Follow existing Notice UX patterns for guardrails so users receive consistent messaging. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]

### File Locations
- Core gating logic belongs in the app layer (`src/app/main.ts`, `src/app/commands.ts`, `src/app/sync-ui.ts`) per the layered architecture. [Source: docs/architecture.md#Layers]
- Modal updates stay within the UI layer (`src/ui/modals/SyncProgressModal.ts` and related tests). [Source: docs/architecture.md#Layers]
- Tests live alongside their features (`src/app/tests`, `src/ui/modals/tests`). [Source: docs/architecture.md#Layers]

### Testing Requirements
- Maintain unit coverage for new gating helpers and short-circuit paths so CI protects against regressions. [Source: docs/epics/two-way-sync-beta-safeguards.md#Quality gates]
- Mirror the manual regression checklist by covering command/status bar/modal permutations in tests. [Source: docs/epics/two-way-sync-beta-safeguards.md#Manual Regression Checklist]
- Prepare for eventual Playwright smoke coverage once the e2e harness lands, ensuring gating hooks expose states that the e2e suite can assert. [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

### Technical Constraints
- Preserve download-only behavior as the safe fallback even when uploads are disallowed. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
- Accessibility expectations call for informative copy, focus handling, and keyboard support on disabled actions and Notices. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- Avoid introducing new premium gating patterns; reuse existing subscription checks. [Source: docs/epics/two-way-sync-beta-safeguards.md#Story Manager Handoff]

### Project Structure Notes
- Architecture configuration references sharded docs that are currently absent; continue relying on `docs/architecture.md` until supplemental files return. [Source: docs/architecture.md#Architecture Overview]

### Testing
- `src/app/tests/main.test.ts`
  - Verify commands stop execution and raise Notices with deep links when safeguards fail. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
  - Confirm imports continue working regardless of safeguards to protect the fallback path. [Source: docs/epics/two-way-sync-beta-safeguards.md#Risk Mitigation]
- `src/app/sync-ui.ts` tests (add or extend)
  - Assert status bar actions disable appropriately and surface helper copy/tooltips for missing prerequisites. [Source: docs/epics/two-way-sync-beta-safeguards.md#Operational Runbook]
- `src/ui/modals/tests/SyncProgressModal.test.ts`
  - Cover gated button states, messaging, and accessibility attributes when uploads are blocked. [Source: docs/epics/two-way-sync-beta-safeguards.md#Stories]
- Future e2e (Playwright sandbox vault) should validate the full gating path once the harness exists. [Source: docs/epics/two-way-sync-beta-safeguards.md#Decision Log]

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-07 | 0.1 | Initial draft created | Bob (Scrum Master) |
| 2025-10-06 | 0.2 | Addressed QA feedback on Sync Progress modal tooltips | James (Dev) |

## Validation Result

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY — Story provides sufficient context for implementation.

## Dev Agent Record

### Agent Model Used
- GPT-5 (Codex)

### Debug Log References
- `npm run test -- SyncProgressModal`

### Completion Notes
- Added centralized two-way gating evaluation, notice helper, and settings deep link opening.
- Wrapped upload/two-way commands, ribbon, status bar menu, and modal actions with safeguard checks and contextual messaging.
- Extended status menu and SyncProgressModal UI to surface gating copy and beta settings shortcut while keeping downloads active.
- Expanded Jest coverage for command short-circuiting, status menu behavior, and modal gating workflows.
- Updated SyncProgressModal tooltips to show sync-in-progress guidance while actions are disabled by active sync and cleared titles once idle.

### File List
- src/app/main.ts
- src/app/commands.ts
- src/app/sync-ui.ts
- src/ui/modals/SyncProgressModal.ts
- src/app/tests/main.test.ts
- src/app/tests/sync-ui.test.ts
- src/ui/modals/tests/SyncProgressModal.test.ts
- **mocks**/obsidian.ts
- docs/stories/1.2.command-ui-safety-gates.md

## QA Results
- Not yet reviewed.

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Centralized gating logic prevents uploads until safeguards pass, status UI reflects prerequisites, and the Sync Progress modal now differentiates between safeguard gating and sync-in-progress states with clear tooltips and ARIA flags. Regression tests cover both paths, so the fix is guarded.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ No lint or style issues observed.
- Project Structure: ✓ Changes stay within existing app/ui/service boundaries.
- Testing Strategy: ✓ Added Jest coverage exercises commands, status menu, and modal behaviors.
- All ACs Met: ✓ Modal messaging now reflects the real blocker (gates vs. in-progress sync).

### Improvements Checklist
- [x] Update `SyncProgressModal` tooltips so in-progress sync disables present a "Sync in progress" message instead of the safeguards guidance.

### Security Review
No new security concerns introduced; changes remain client-side gating only.

### Performance Considerations
No performance risks identified; gating checks reuse existing settings and cached subscription data.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/1.2-command-ui-safety-gates.yml
Risk profile: Not produced during this review.
NFR assessment: Not produced during this review.

### Recommended Status
✓ Ready for Done
